% stuff to be used whe compiling only one chapter -- e.e for revision and committee approval

\documentclass{article}

%% Compile this with
%% R> library(pgfSweave)
%% R> pgfSweave

%\usepackage[nogin]{Sweave} %way to understand R code
\usepackage{pgf} %look it up
\usepackage{tikz} % allows R code or other stuff in the figure labels
\usepackage{rotating}
\usepackage{color}
\definecolor{greytext}{gray}{0.5}
\usepackage[left=1.2in,right=1.2in,top=1.2in,bottom=1.2in]{geometry} % sets the margins
\usepackage{fancyhdr}
\usepackage{setspace}
\usepackage{indentfirst}
\usepackage{titlesec}
\usepackage{natbib}
\usepackage{checkend}   % better error messages on left-open environments
\usepackage{graphicx}   % for incorporating external images

\newcommand{\lang}{\textsf} %
\newcommand{\code}{\texttt}
\newcommand{\pkg}{\texttt}
\newcommand{\ques}[1]{{\bf\large#1}}
\newcommand{\eb}{\\ \nonumber} 

\doublespacing

\usepackage{times,mathptmx,courier}
\usepackage[scaled=1]{helvet}
\usepackage{lineno}
\usepackage{listings}
\lstset{basicstyle=\sffamily\scriptsize,showstringspaces=false,fontadjust}

\usepackage{fixme}%you probably wan't this 
%% Math or theory people may want to include the handy AMS macros
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{float}

%% The pifont package provides access to the elements in the dingbat font.   
%% Use \ding{##} for a particular dingbat (see p7 of psnfss2e.pdf)
%%   Useful:
%%     51,52 different forms of a checkmark
%%     54,55,56 different forms of a cross (saltyre)
%%     172-181 are 1-10 in open circle (serif)
%%     182-191 are 1-10 black circle (serif)
%%     192-201 are 1-10 in open circle (sans serif)
%%     202-211 are 1-10 in black circle (sans serif)
%% \begin{dinglist}{##}\item... or dingautolist (which auto-increments)
%% to create a bullet list with the provided character.
\usepackage{pifont}
\usepackage[printonlyused,nohyperlinks]{acronym}

\usepackage{comment}



\titleformat*{\section}{\singlespacing\raggedright\bfseries\Large}
\titleformat*{\subsection}{\singlespacing\raggedright\bfseries\large}
\titleformat*{\subsubsection}{\singlespacing\raggedright\bfseries}
\titleformat*{\paragraph}{\singlespacing\raggedright\itshape}

%% The caption package provides support for varying how table and
%% figure captions are typeset.
\usepackage[format=hang,indention=-1cm,labelfont={bf},margin=1em]{caption}

%% url: for typesetting URLs and smart(er) hyphenation.
%% \url{http://...} 
\usepackage{url}
\urlstyle{sf}   % typeset urls in sans-serif
%\graphicspath{{/home/daft/Dropbox/figures/}{/home/daft/Dropbox/figures/cpue_figures/}} % set the path to figures folder
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% Possibly useful packages: you may need to explicitly install
%% these from CTAN if they aren't part of your distribution;
%% teTeX seems to ship with a smaller base than MikTeX and MacTeX.
%%
%\usepackage{pdfpages}  % insert pages from other PDF files
%\usepackage{longtable} % provide tables spanning multiple pages
%\usepackage{chngpage}  % support changing the page widths on demand
%\usepackage{tabularx}  % an enhanced tabular environment

%% enumitem: support pausing and resuming enumerate environments.
%\usepackage{enumitem}

%% rotating: provides two environments, sidewaystable and sidewaysfigure,
%% for typesetting tables and figures in landscape mode.  
%\usepackage{rotating}

%% subfig: provides for including subfigures within a figure,
%% and includes being able to separately reference the subfigures.
\usepackage{subfig}


\usepackage[bookmarks,bookmarksnumbered,%
    citebordercolor={0.8 0.8 0.8},filebordercolor={0.8 0.8 0.8},%
    linkbordercolor={0.8 0.8 0.8},%pagebordercolor={0.8 0.8 0.8},
    urlbordercolor={0.8 0.8 0.8},
    linktocpage%
    ]{hyperref}
%%\usepackage[bookmarks,bookmarksnumbered,%
%%    citebordercolor={0.8 0.8 0.8},filebordercolor={0.8 0.8 0.8},%
%%    linkbordercolor={0.8 0.8 0.8},pagebordercolor={0.8 0.8 0.8},%
%%    urlbordercolor={0.8 0.8 0.8},%
%%    pagebackref,linktocpage%
%%    ]{hyperref}
%% The following change how the the back-references text is typeset in a
%% bibliography when `backref' or `pagebackref' are used
%\renewcommand\backrefpagesname{\(\rightarrow\) pages}
%\renewcommand\backref{\textcolor{greytext} \backrefpagesname\ }

%allow use of \degree command
\usepackage{gensymb}

\usepackage{lineno}
\linenumbers



%% The following is used for tables of equations.
\newcounter{saveEq} 
\def\putEq{\setcounter{saveEq}{\value{equation}}} 
\def\getEq{\setcounter{equation}{\value{saveEq}}} 
\def 
\tableEq{ 

% equations in tables
\putEq \setcounter{equation}{0} 
\renewcommand{\theequation}{T\arabic{table}.\arabic{equation}} \vspace{-5mm} } 
\def\normalEq{ 

% renew normal equations
\getEq 
\renewcommand{\theequation}{\arabic{section}.\arabic{equation}}}
\newcommand{\normal}[2]{\ensuremath{N(#1,#2)}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% Some special settings that controls how text is typeset
%%
 \raggedbottom      % pages don't have to line up nicely on the last line
% \sloppy       % be a bit more relaxed in inter-word spacing
 \clubpenalty=10000 % try harder to avoid orphans
 \widowpenalty=20000    % try harder to avoid widows
% \tolerance=1000




\title{Stock Reduction Analysis using catch at length data}            
\author{Catarina Wor, Roberto Licandeo,  Brett van Poorten, Carl Walters}
%\pgfrealjobname{pgfSweave-vignette}
%pgfSweave-vignette
\begin{document}

\maketitle

\begin{abstract}
   Last thing to be written
\end{abstract}


\section{Introduction}

%(old intro written by Carl Walters)
Modern stock assessments typically attempt to fit population dynamics models to catch at age and catch at length data, in hopes of extracting information from these data about age/size vulnerability and fishing mortality patterns \citep{methot_stock_2013,hilborn_quantitative_1992}.  In cases where age data are lacking, models like MULTIFAN-CL attempt to obtain estimates of vulnerability and fishing mortality only from size distribution data \citep{fournier_multifan-cl:_1998}. Combined with a few assumptions regarding the structure and variability in length at age, this procedure can even be used to attempt to recover information about changes in body growth patterns if there is a strong age-class signal in the length frequency data \citep{fournier_multifan-cl:_1998}.  Some assessment methods attempt to put aside the length frequency data, by converting these data to age compositions using age-from-length tables, perhaps using iterative methods to estimate proportions of fish at age for each length interval \citep{kimura_mixtures_1987}.  It is typical for assessment results from length-based assessment models to show substantial deviations between predicted and observed length distributions of catches, reflecting both sampling variation in the length composition data and incorrect assumptions about stability of growth and vulnerability patterns (reference). 
 
The vulnerability process is the combination of two processes: selectivity of the fishing gear and availability of the fished population in the area being fished. Both processes can vary over time and therefore modify the resulting selectivity. Although selectivity process can often be directly measured through gear experiments, availability is generally harder to measure as it depends on the distribution of the exploited population. Changes in availability occur when changes in the spatial distribution of the fleet in relation to the fished population happen. These changes can be caused by changes in fish distribution, fleet distribution or both. Fish distribution can change over time due to environmental forces or changes in population size or age structure. Changes in fleet distribution can occur due to new regulation (e.g. bycatch avoidance, closed areas, etc) of due to targeting of abundant cohorts if the fished population segregates by size or age. Time varying vulnerability is therefore, not uncommon. However it can be difficult to track such changes as it can be very hard to separate the effects of changes in fishing mortality and changes in selectivity in most currently available age and length based stock assessment methods. For this reason, many assessment methods rely on ad hoc parametric vulnerability models that may or may not include changes over time. If misspecified, such models might lead to severe bias in fishing mortality estimates, which could result in misleading management advice. 


 Here we suggest an alternative approach to assessment modeling that begins by assuming that the assessment model should exactly reproduce the observed catch at length distribution. This is similar to the classical assumption in virtual population analysis that reconstructed numbers at age should exactly match observed catch at age data \citep{hilborn_quantitative_1992}. This assumption is also analogous to the suggestion by \citet{schnute_general_1994} that statistical catch at age models might best be run in a``conditioned on catch'' format by subtracting observed catches at age from modeled numbers at age in estimation of numbers at age over time.  The suggested approach may have two key advantages over statistical catch at age and/or catch at length models: (1) it does not require estimation of age or size vulnerability schedules, and (2) catch at length data are commonly available for every year, even when age composition sampling has not been conducted. 

 We demonstrate the performance of this model with a simulation-evaluation analysis and apply it to real fisheries data from the Chilean jack mackerel and Pacific Hake fisheries. 



\section{Methods}

In this section we describe the stock reduction analysis with catch at length data, describe the simulation analysis and scenarios used to test the model and provide a description of the real data used to illustrate the model applicability.


\subsection{Stock reduction analysis with catch at length data}

The stock reduction analysis described here starts by calculating , the proportions of individual at length for each age class (Table \ref{tab:length_age}. The calculation of such proportions relies on three main assumptions regarding the distribution of length at age: (1) The mean length at age follows a von Bertalanffy growth curve (eq.\ref{T1.4}), (2) The length at age is normally distributed (eqs. \ref{T1.1} -\ref{T1.3}) and (3) The standard deviations of the length at age distributions is given by the product of the mean length at age and a constant CV (eq.\ref{T1.5}). 

	
\begin{table}
  %\centering
  \Large
\caption{ \large Age at Length}\label{tab:length_age} 
\tableEq
    \begin{align}
           \hline
       		&\mbox{Variable definition} \nonumber \\ 
            &\mbox{$P_{l|a}$ = Matrix of proportions of lengh  at age} &\nonumber\\ 
            &\mbox{$z1_{a,l}$ = Normalized Z score for lower limit length bins}&\nonumber\\ 
            &\mbox{$z2_{a,l}$ = Normalized Z score for upper limit length bins}&\nonumber\\
            &\mbox{$b1_{l}$ = Lower limit of length bins}&\nonumber\\ 
            &\mbox{$b2_{l}$ = upper limit of length bins}&\nonumber\\ 
            &\mbox{$\bar{L}_a$ = Mean length at age}&\nonumber\\ 
            &\mbox{$\sigma_{L_a}$ = Standard deviation of lengh at age}&\nonumber\\ 
            &\mbox{${L_{inf}}$ =  Maximum average length }&\nonumber\\ 
            &\mbox{${k}$ =  rate of approach to $L_{inf}$}&\nonumber\\
            &\mbox{${t_o}$ =  Theoretical time in which length of individuals is zero}&\nonumber\\ 
            &\mbox{$cvL$ = Coefficient of variation for length curve}&\\
        \hline \nonumber \\
            &\mbox{Age-schedule information} \nonumber \\ \nonumber \\
            %
            P_{l|a}&= \int_{z1_{a,l}}^{z2_{a,l}}{ \mathcal{N}(0,1)}  \label{T1.1}\\
            z1_{a,l} &= \frac{b1_{l} - \bar{L}_{a}}{\sigma_{L_{a}}} \label{T1.2}\\
            z2_{a,l} &= \frac{b2_{l} - \bar{L}_{a}}{\sigma_{L_{a}}} \label{T1.3}\\
            \bar{L}_{a} &= L_{inf} \cdot (1 - \exp^{(-k\cdot(a-t_o))})  \label{T1.4}\\
            \sigma_{L_{a}} &= \bar{L}_{a} \cdot cvL  \label{T1.5}\\
            \nonumber \\
        \hline \hline \nonumber
    \end{align}
    \normalEq
\end{table}

 The proportions of length at age is used to convert the length based quantities into age based quantities which are used to propagate the age structured population dynamics forward (Table \ref{tab:pop_dyn}). We assume that recruitment follows a Beverton \& Holt type recruitment curve (eq. \ref{T2.1}), that harvesting occurs over a short, discrete season in each time step (year or shorter time period) and that natural survival rate is stable over time (eqs. \ref{T2.1}-\ref{T2.5}). Differences in the population dynamics equations in the initial year as well as incidence functions are shown in  Table \ref{tab:pop_dyn_syr}.
	
\begin{table}
  %\centering
  \Large
\caption{ \large Population dynamics}\label{tab:pop_dyn} 
\tableEq
    \begin{align}
           \hline
       		&\mbox{Variable definition} \nonumber \\ 
            &\mbox{$N_{a,t}$ = Numbers of fish at age and time} &\nonumber\\
            &\mbox{$SB_{t}$ = Spawning biomass at time t} &\nonumber\\
            &\mbox{$a_{rec}, b_{rec}$ = Beverton  \& Holt stock recruitment parameters } &\nonumber\\
            &\mbox{$wt$ = Normally distributed recruitment deviations} &\nonumber\\
            &\mbox{$S_a$ = Survival rate at age} &\nonumber\\
            &\mbox{$U_{a,t}$ = Exploitation rate at age and time} &\nonumber\\
            &\mbox{$U_{l,t}$ = Exploitation rate at length and time} &\nonumber\\
            &\mbox{$C_{l,t}$ = Catch at length and time} &\nonumber\\
             &\mbox{$N_{l,t}$ = Numbers at length and time} &\nonumber\\
             &\mbox{$syr$ = Initial year of data} &\nonumber\\
            &\mbox{$a_o$ = Age of recruitment} &\nonumber\\
           \hline \nonumber \\
             &\mbox{Age-schedule information} \nonumber \\ 
            %
            N_{a,t>syr}&=\begin{cases} \frac{a_{rec} \cdot SB_{t-1}}{1+ b_{rec} \cdot SB_{t-1}} \cdot e^{wt}, &\quad a=a_o \\ \\
            %
            N_{a-1,t-1}\cdot S_{a-1}\cdot(1-U_{a-1,t-1}),&\quad 1<a<A \\ \\
            %
            \frac{N_{a-1,t-1} \cdot S_{a-1} \cdot (1-U_{a-1,t-1})}{1- S_{A} \cdot 1-U{a,t}},&\quad a=A \\
            \end{cases}\label{T2.1}\\
            U_{a,t}&=\sum_a{(P_{l|a}\cdot U_{l,t})}\label{T2.2}\\
            U_{l,t}&=\frac{C_{l,t}}{N_{l,t}}\label{T2.3}\\
            N_{l,t}&=\sum_a{(P_{l|a}\cdot N_{a,t})}\label{T2.4}\\
            SB_{t}&= \sum_a(fec_a \cdot w_a \cdot N_{a,t}) \label{T2.5}\\
        \hline \hline \nonumber
    \end{align}
    \normalEq
\end{table}

\begin{table}
  %\centering
  \Large
\caption{ \large Population dynamics: initial year and incidence functions}\label{tab:pop_dyn_syr} 
\tableEq
    \begin{align}
           \hline
            &\mbox{Variable definition} \nonumber \\ 
            &\mbox{$N_{a,t}$ = Numbers of fish at age and time} &\nonumber\\
             &\mbox{$syr$ = Initial year of data} &\nonumber\\
            &\mbox{$a_o$ = Age of recruitment} &\nonumber\\
            &\mbox{$a_{rec}, b_{rec}$ = Beverton  \& Holt stock recruitment parameters } &\nonumber\\
            &\mbox{$\phi_e$ = Unfished average spawning biomass per recruit } &\nonumber\\
           \hline \nonumber \\
            &\mbox{Initial year } \nonumber \\ 
            N_{a=a_o,t=syr}&= R_{init} * \cdot e^{wt} \label{T3.1}\\
            a_{rec}&=  \frac{k_{rec}}{\phi_e} \label{T3.2}\\
            b_{rec}&= \frac{k_{rec}-1}{R_o \cdot \phi_e}  \label{T3.4}\\
            \phi_e &= \sum_a{lx_a}  \label{T3.5}\\
            lx_a &= \begin{cases} 1 , &\quad a=a_o \\
            lx_{a-1} \cdot S_{a-1} ,&\quad 1<a<A \\ 
            \frac{lx_{a-1} \cdot S_{a-1}}{1-S_{A}} ,&\quad a=A \\
             \end{cases}\label{T3.6}\\
        \hline \hline \nonumber
    \end{align}
    \normalEq
\end{table}


The model estimates three main parameters: the average unexploited recruitment $R_{0}$, the recruitment compensation ratio $k_{rec}$  and the recruitment in the initial year $R_{init} $. In addition, the recruitment deviations are estimated for all cohorts observed in the model, that is, the number of recruitment deviations is equal to the number of years in the time series plus the number of age classes greater that recruitment age. 
The parameters of the model are estimated with two likelihood components: Index of abundance and Recruitment deviations, both are assumed to be lognormally distributed with fixed variances.

In order to perform a simulation evaluation of the length-SRA under various scenarios we used the same model dynamics described in Table \ref{tab:pop_dyn} as an operating model. However we modified the model population dynamics to include time varying selectivity and a maximum annual exploitation rate (eq. \ref{T4.1}) as well as observation and process errors. Selectivity in the operating model was computed with the three parameter selectivity equation described by \citet{thompson_confounding_1994} (eq. \ref{T4.3}). The observation error in the operating model included lognormal error in the index of abundance and logistic multivariate error in the catch numbers at length. Recruitment deviations were assumed to be lognormally distributed.   

\begin{table}
  %\centering
  \Large{}
\caption{ \large Population dynamics: changes in operating model}\label{tab:pop_dyn_om} 
\tableEq
    \begin{align}
           \hline
            &\mbox{Variable definition} \nonumber \\ 
            &\mbox{$U_{l,t}$ = Exploitation rate at length and time} &\nonumber\\
            &\mbox{$sel_{l,t}$ = fishing selectivity at length and time} &\nonumber\\
            &\mbox{$U_{t}$ = annual maximum exploitation rate} &\nonumber\\
            &\mbox{$C_{l,t}$ = Catch at length and time} &\nonumber\\
             &\mbox{$N_{l,t}$ = Numbers at length and time} &\nonumber\\
           \hline \nonumber \\
        &\mbox{Operating model} \nonumber \\ 
            U_{l,t}&= U_{t} \cdot sel_{l,t}\label{T4.1}\\           
            C_{l,t}&= N_{l,t} \cdot  U_{l,t} \cdot P_{l|a}\label{T4.2}\\
            sel_{l,t} &= \frac{1}{1-g}\cdot \left(\frac{1-g}{g}\right)^{g} \cdot \frac{e^{a\cdot g\cdot (b-l)}}{1+e^{a\cdot(b-l)}}\label{T4.3}\\
            %S(l)=(1/(1-g))*((1-g)/g)^g*((exp(a*g*(b-l)))/(1+exp(a*(b-l))))
         \hline \hline \nonumber 
    \end{align}
    \normalEq
\end{table}



\subsection{Simulation evaluation scenarios}


We tested a total of six different scenarios in the simulation evaluation runs.  We tested three different historical exploitation rate trajectories: contrast, one way trip and $U$ ramp. In the contrast scenario the exploitation rate($U$) starts low and increases up to $U>U_{msy}$ and then decreases until $U=U_{msy}$. In the one way trip scenario $U$ increased through time until $U=2 \cdot U_{msy} $. In the $U$ ramp scenario, U increases steadily until $U=U_{msy}$ and remains constant. 
In addition to the exploitation rate scenarios, we considered two selectivity scenarios: constant and time varying selectivity. In the constant selectivity scenario, selectivity was assumed to follow a sigmoid shape. In the time varying selectivity scenario, the selectivity curve was assumed to vary every year, progressively changing form a dome shaped curve to sigmoid and back to dome shaped. 

All simulation runs had 30 years of data and we used 200 simulation runs for each scenario. 

\subsection{Real data examples}

Two species were chosen to illustrate the application of the model to real datasets: Chilean jack mackerel and Pacific hake. 

Have to come up with good justification for these species. 
Pacific hake is migratory and shows spasmodic recruitment episodes


\section{Results}

\subsection{Simulation-evaluation}

and simulated data

\subsection{Real data examples}

show figures with real 

\section{Discussion}

Does the model work?

assumption regarding Umsy -> changes with selectivity

Time- varying growth might render the model less useful. Suggest estimating 
cohort-specific growth curves or implementing the density dependent functions shown in multifan-CL. 

\clearpage

 \bibliographystyle{apa}
       \bibliography{references.bib}


\end{document}
